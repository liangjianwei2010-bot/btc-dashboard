<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Bitcoin Dashboard</title>
  <meta name="description" content="Personal Bitcoin status & risk dashboard." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --bg:#0f1115; --card:#171a21; --text:#e6e6e6; --muted:#9aa0a6; --accent:#4da3ff;
      --good:#27ae60; --warn:#f1c40f; --bad:#e74c3c;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; }
    header{ padding:20px 16px; border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .brand{ font-weight:700; letter-spacing:0.2px }
    .grid{ display:grid; gap:16px; padding:16px; grid-template-columns:1fr; max-width:1200px; margin:0 auto }
    @media (min-width:900px){ .grid{ grid-template-columns:repeat(12,1fr) } }
    .card{ background:var(--card); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:16px; box-shadow:0 10px 25px rgba(0,0,0,0.3) }
    .span-6{ grid-column:span 6 } .span-12{ grid-column:span 12 }
    .kpis{ display:flex; gap:16px; flex-wrap:wrap }
    .kpi{ flex:1 1 160px; background:rgba(255,255,255,0.05); border-radius:12px; padding:12px 14px }
    .kpi h3{ margin:0 0 6px 0; font-size:13px; color:var(--muted); font-weight:600; letter-spacing:0.3px }
    .kpi .val{ font-size:22px; font-weight:700; transition: color .2s ease }
    .chg.up{ color:var(--good) } .chg.down{ color:var(--bad) }
    .risk-pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:0.3px;
      transition: color .2s ease, background-color .2s ease, border-color .2s ease }
    .risk-low{ background:rgba(39,174,96,0.15); color:var(--good); border:1px solid rgba(39,174,96,0.35) }
    .risk-medium{ background:rgba(241,196,15,0.15); color:var(--warn); border:1px solid rgba(241,196,15,0.35) }
    .risk-high{ background:rgba(231,76,60,0.15); color:var(--bad); border:1px solid rgba(231,76,60,0.35) }
    .muted{ color:var(--muted) } .small{ font-size:12px } footer{ padding:24px 16px; text-align:center; color:var(--muted) }
    canvas{ width:100%; height:300px }
    .tv-box, .ratio-box{ position:relative; width:100%; height:420px; border-radius:12px; overflow:hidden; background:rgba(255,255,255,0.05) }
    .ratio-box{ padding-top:56.25%; height:auto; }
    .ratio-box iframe{ position:absolute; inset:0; width:100%; height:100%; border:0 }
    .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px }
    .btn{ background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.2); padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer }
    .btn:hover{ filter:brightness(1.2) }

    /* Flash highlights */
    @keyframes flashUp { 0%{ color:var(--good) } 100%{ color:var(--text) } }
    @keyframes flashDown { 0%{ color:var(--bad) } 100%{ color:var(--text) } }
    @keyframes flashNeutral { 0%{ color:var(--accent) } 100%{ color:var(--text) } }
    .flash-up   { animation: flashUp .8s ease; }
    .flash-down { animation: flashDown .8s ease; }
    .flash      { animation: flashNeutral .8s ease; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Mick — Bitcoin Status</div>
    <div class="muted small" id="updated">Loading…</div>
  </header>

  <main class="grid">
    <!-- KPIs -->
    <section class="card span-12">
      <div class="kpis">
        <div class="kpi">
          <h3>BTC Price (USDT)</h3>
          <div class="val" id="price">—</div>
          <div id="priceChange" class="small muted">—</div>
        </div>
        <div class="kpi">
          <h3>Fear & Greed (now)</h3>
          <div class="val" id="fgi">—</div>
          <div class="small muted" id="fgiLabel">—</div>
        </div>
        <div class="kpi">
          <h3>USD/SEK</h3>
          <div class="val" id="usdsek">—</div>
          <div class="small muted">Source: Frankfurter</div>
        </div>
        <div class="kpi">
          <h3>Risk Level</h3>
          <div class="val"><span id="riskPill" class="risk-pill">—</span></div>
          <div class="small muted">Based on F&G + 24h change</div>
        </div>
        <div class="kpi">
          <h3>MVRV-Z (est. now)</h3>
          <div class="val" id="mvrvNow">—</div>
          <div class="small muted" id="mvrvNote">Using live price × supply</div>
        </div>
      </div>
    </section>

    <!-- Fear & Greed chart -->
    <section class="card span-6">
      <h3 style="margin-top:0">Fear & Greed — last 30 days</h3>
      <canvas id="fgiChart"></canvas>
      <div class="small muted">Source: Alternative.me</div>
    </section>

    <!-- BTC Dominance -->
    <section class="card span-6">
      <h3 style="margin-top:0">Bitcoin Dominance (BTC.D)</h3>
      <div id="tv-btcd" class="tv-box"></div>
      <div class="actions">
        <button data-reload="btcd" class="btn">Reload chart</button>
        <a class="btn" href="https://www.tradingview.com/chart?symbol=CRYPTOCAP%3ABTC.D" target="_blank" rel="noopener">Open in TradingView ↗</a>
      </div>
      <div class="small muted">Source: TradingView</div>
    </section>

    <!-- MSTR NAV -->
    <section class="card span-12">
      <h3 style="margin-top:0">MSTR — NAV Premium (Basic)</h3>
      <div id="mnav-embed" class="ratio-box"></div>
      <div class="small muted">Source: StrategyTracker. If blocked, open below.</div>
      <div class="actions">
        <a class="btn" href="https://strategytracker.com/mstr" target="_blank" rel="noopener">Open on StrategyTracker ↗</a>
      </div>
    </section>
  </main>

  <footer>Built for personal use • Data: Binance, Alternative.me, Frankfurter, TradingView, Coin Metrics, StrategyTracker</footer>

  <!-- Chart.js (for F&G history) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /* =========================
       CONFIG / HELPERS
    ==========================*/
    // MVRV proxy you used before
    const MVRV_API = "https://mvrvz.netlify.app/.netlify/functions/cm-mvrv";

    const els = {
      updated: document.getElementById('updated'),
      price: document.getElementById('price'),
      priceChange: document.getElementById('priceChange'),
      fgi: document.getElementById('fgi'),
      fgiLabel: document.getElementById('fgiLabel'),
      usdsek: document.getElementById('usdsek'),
      riskPill: document.getElementById('riskPill'),
      tvBtcd: document.getElementById('tv-btcd'),
      mnavBox: document.getElementById('mnav-embed'),
      mvrvNow: document.getElementById('mvrvNow'),
      mvrvNote: document.getElementById('mvrvNote'),
    };

    const fmtUSD = (n) => Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const prev = { price:null, fgi:null, usdsek:null, mvrv:null, riskComposite:null };

    function flash(el, dir){
      if (!el) return;
      el.classList.remove('flash-up','flash-down','flash');
      void el.offsetWidth; // reflow to retrigger animation
      el.classList.add(dir === 'up' ? 'flash-up' : dir === 'down' ? 'flash-down' : 'flash');
    }
    function deltaFlash(el, next, prevVal){
      if (prevVal == null || !isFinite(next)) { flash(el,'neutral'); return next; }
      if (next > prevVal) flash(el,'up');
      else if (next < prevVal) flash(el,'down');
      else flash(el,'neutral');
      return next;
    }

    /* =========================
       KPI REFRESH (every 5s), resilient per source
    ==========================*/
    async function refreshKPIs(){
      let fgiNum = NaN;
      let chgPct = NaN;

      // 1) BTC — Binance 24h ticker
      try {
        const r1 = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
        const j1 = await r1.json();
        const priceNum = parseFloat(j1.lastPrice);
        els.price.textContent = fmtUSD(priceNum);
        prev.price = deltaFlash(els.price, priceNum, prev.price);
        chgPct = parseFloat(j1.priceChangePercent);
        if (isFinite(chgPct)) {
          els.priceChange.textContent = `${chgPct.toFixed(2)}% (24h)`;
          els.priceChange.className = 'small ' + (chgPct >= 0 ? 'chg up' : 'chg down');
        } else {
          els.priceChange.textContent = '—';
          els.priceChange.className = 'small';
        }
      } catch(e){
        console.warn('BTC fetch failed', e);
      }

      // 2) Fear & Greed — latest only
      try {
        const r2 = await fetch('https://api.alternative.me/fng/?limit=1&format=json');
        const j2 = await r2.json();
        const cur = j2.data?.[0];
        fgiNum = parseInt(cur?.value ?? 'NaN', 10);
        if (isFinite(fgiNum)) {
          els.fgi.textContent = fgiNum;
          prev.fgi = deltaFlash(els.fgi, fgiNum, prev.fgi);
          els.fgiLabel.textContent = cur?.value_classification ?? '';
        } else {
          els.fgi.textContent = '—';
          els.fgiLabel.textContent = '—';
        }
      } catch(e){
        console.warn('FGI fetch failed', e);
      }

      // 3) USD/SEK — Frankfurter
      try {
        const fxResp = await fetch('https://api.frankfurter.app/latest?from=USD&to=SEK', { cache:'no-store' });
        if (!fxResp.ok) throw new Error(`Frankfurter ${fxResp.status}`);
        const fx = await fxResp.json(); // { amount, base, date, rates: { SEK: number } }
        const rateNum = Number(fx?.rates?.SEK);
        if (isFinite(rateNum)) {
          els.usdsek.textContent = `${rateNum.toLocaleString(undefined,{ maximumFractionDigits:4 })} SEK`;
          prev.usdsek = deltaFlash(els.usdsek, rateNum, prev.usdsek);
        } else {
          els.usdsek.textContent = '—';
        }
      } catch(e){
        console.warn('USD/SEK fetch failed', e);
        els.usdsek.textContent = '—';
      }

      // 4) MVRV-Z — realtime estimate via your proxy
      try {
        const r4 = await fetch(MVRV_API, { cache:'no-store' });
        if (r4.ok) {
          const j4 = await r4.json();
          const nowZ = Number(j4?.realtime?.z ?? j4?.last?.z);
          if (isFinite(nowZ)) {
            els.mvrvNow.textContent = nowZ.toFixed(2);
            prev.mvrv = deltaFlash(els.mvrvNow, nowZ, prev.mvrv);
            els.mvrvNote.textContent = j4.realtime ? "Using live price × supply" : "Latest daily close";
          } else {
            els.mvrvNow.textContent = '—';
          }
        } else {
          els.mvrvNow.textContent = '—';
        }
      } catch(e){
        console.warn('MVRV fetch failed', e);
        els.mvrvNow.textContent = '—';
      }

      // 5) Risk pill (simple composite, only if we have the inputs)
      try {
        if (isFinite(fgiNum) && isFinite(chgPct)) {
          const composite = 0.7 * fgiNum + 0.3 * (Math.min(Math.abs(chgPct),10)*10);
          let level='HIGH', cls='risk-high';
          if (composite<40){ level='LOW'; cls='risk-low'; }
          else if (composite<=65){ level='MEDIUM'; cls='risk-medium'; }
          els.riskPill.className='risk-pill '+cls;
          els.riskPill.textContent=`${level} (${Math.round(composite)})`;
          prev.riskComposite = deltaFlash(els.riskPill, composite, prev.riskComposite);
        } else {
          els.riskPill.className='risk-pill';
          els.riskPill.textContent='—';
        }
      } catch(e){
        console.warn('Risk compute failed', e);
        els.riskPill.className='risk-pill';
        els.riskPill.textContent='—';
      }

      // Always stamp "Updated" so you know a cycle completed
      els.updated.textContent = "Updated: " + new Date().toLocaleString();
    }

    /* =========================
       ONE-TIME LOADS
    ==========================*/
    function lineChart(canvasId, points, label, yTitle){
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx,{
        type:'line',
        data:{ labels: points.map(p=>p.t.toLocaleDateString()),
               datasets:[{label,data:points.map(p=>p.v),tension:0.3,fill:false}] },
        options:{ scales:{ y:{ beginAtZero:true, title:{ display:true, text:yTitle } } },
                  plugins:{ legend:{ display:false } } }
      });
    }

    async function loadFgiChart(){
      try{
        const r = await fetch('https://api.alternative.me/fng/?limit=30&format=json');
        const { data } = await r.json();
        const series = (data||[]).slice().reverse().map(d=>({t:new Date(d.timestamp*1000), v:parseInt(d.value,10)}));
        if (series.length) lineChart('fgiChart', series, 'Fear & Greed', 'Index (0–100)');
      }catch(e){ console.warn('FGI chart failed', e); }
    }

    function mountTradingView(container, symbol){
      container.innerHTML='';
      const s=document.createElement('script');
      s.src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
      s.async=true;
      s.innerHTML=JSON.stringify({autosize:false,width:"100%",height:420,symbol,interval:"D",timezone:"Europe/Stockholm",theme:"dark",style:"3",locale:"en"});
      const wrap=document.createElement('div');wrap.className="tradingview-widget-container";wrap.style.height="420px";
      const cont=document.createElement('div');cont.className="tradingview-widget-container__widget";cont.style.height="100%";
      wrap.appendChild(cont);wrap.appendChild(s);container.appendChild(wrap);
    }

    function mountMnavEmbed(){
      const iframe=document.createElement('iframe');
      iframe.src="https://strategytracker.com/mstr?embed=1";
      iframe.loading="lazy";
      iframe.referrerPolicy="no-referrer-when-downgrade";
      els.mnavBox.appendChild(iframe);
    }

    /* =========================
       INIT
    ==========================*/
    async function init(){
      await refreshKPIs();           // first paint
      await loadFgiChart();          // chart once
      mountTradingView(els.tvBtcd,"CRYPTOCAP:BTC.D");
      mountMnavEmbed();
      setInterval(refreshKPIs, 5000); // KPIs every 5s
    }
    init();
  </script>
</body>
</html>
