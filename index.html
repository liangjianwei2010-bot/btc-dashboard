<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Bitcoin Dashboard</title>
  <meta name="description" content="Personal Bitcoin status & risk dashboard." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{ --bg:#0f1115; --card:#171a21; --text:#e6e6e6; --muted:#9aa0a6; --accent:#4da3ff; --good:#27ae60; --warn:#f1c40f; --bad:#e74c3c; }
    @media (prefers-color-scheme: light){
      :root{ --bg:#ffffff; --card:#f6f8fb; --text:#1b1f24; --muted:#5f6368; --accent:#1565c0; --good:#1e7d4f; --warn:#a17900; --bad:#b3392d; }
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial }
    header{ padding:20px 16px; border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap }
    .brand{ font-weight:700; letter-spacing:0.2px }
    .grid{ display:grid; gap:16px; padding:16px; grid-template-columns:1fr; max-width:1200px; margin:0 auto }
    @media (min-width:900px){ .grid{ grid-template-columns:repeat(12,1fr) } }
    .card{ background:var(--card); border:1px solid rgba(0,0,0,0.2); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.2) }
    .span-6{ grid-column:span 6 } .span-12{ grid-column:span 12 }
    .kpis{ display:flex; gap:16px; flex-wrap:wrap }
    .kpi{ flex:1 1 160px; background:rgba(255,255,255,0.03); border-radius:12px; padding:12px 14px }
    .kpi h3{ margin:0 0 6px 0; font-size:13px; color:var(--muted); font-weight:600; letter-spacing:0.3px }
    .kpi .val{ font-size:22px; font-weight:700 }
    .chg.up{ color:var(--good) } .chg.down{ color:var(--bad) }
    .risk-pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; letter-spacing:0.3px }
    .risk-low{ background:rgba(39,174,96,0.15); color:var(--good); border:1px solid rgba(39,174,96,0.35) }
    .risk-medium{ background:rgba(241,196,15,0.15); color:var(--warn); border:1px solid rgba(241,196,15,0.35) }
    .risk-high{ background:rgba(231,76,60,0.15); color:var(--bad); border:1px solid rgba(231,76,60,0.35) }
    .muted{ color:var(--muted) } .small{ font-size:12px } footer{ padding:24px 16px; text-align:center; color:var(--muted) }
    canvas{ width:100%; height:300px }

    /* Widgets */
    .tv-box, .ratio-box{ position:relative; width:100%; height:420px; border-radius:12px; overflow:hidden; background:rgba(255,255,255,0.03); }
    .ratio-box{ padding-top:56.25%; height:auto; }
    .ratio-box iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
    .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px }
    .btn{ background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.2); padding:6px 10px; border-radius:10px; font-size:12px; cursor:pointer }
    .btn:hover{ filter:brightness(1.1) }
    .center{ display:flex; align-items:center; justify-content:center; height:240px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <div class="brand">Mick — Bitcoin Status</div>
    <div class="muted small" id="updated">Loading…</div>
  </header>

  <main class="grid">
    <!-- KPIs -->
    <section class="card span-12">
      <div class="kpis">
        <div class="kpi">
          <h3>BTC Price (USDT)</h3>
          <div class="val" id="price">—</div>
          <div id="priceChange" class="small muted">—</div>
        </div>
        <div class="kpi">
          <h3>Fear & Greed (now)</h3>
          <div class="val" id="fgi">—</div>
          <div class="small muted" id="fgiLabel">—</div>
        </div>
        <div class="kpi">
          <h3>USD/SEK</h3>
          <div class="val" id="usdsek">—</div>
          <div class="small muted">Source: frankfurter.app</div>
        </div>
        <div class="kpi">
          <h3>Risk Level</h3>
          <div class="val"><span id="riskPill" class="risk-pill">—</span></div>
          <div class="small muted">Based on F&G + 24h change</div>
        </div>
      </div>
    </section>

    <!-- Fear & Greed chart -->
    <section class="card span-6">
      <h3 style="margin-top:0">Fear & Greed — last 30 days</h3>
      <canvas id="fgiChart"></canvas>
      <div class="small muted">Source: Alternative.me</div>
    </section>

    <!-- BTC Dominance (TradingView) -->
    <section class="card span-6">
      <h3 style="margin-top:0">Bitcoin Dominance (BTC.D)</h3>
      <div id="tv-btcd" class="tv-box"></div>
      <div class="actions">
        <button data-reload="btcd" class="btn">Reload chart</button>
        <a class="btn" href="https://www.tradingview.com/chart?symbol=CRYPTOCAP%3ABTC.D" target="_blank" rel="noopener">Open in TradingView ↗</a>
      </div>
      <div class="small muted">Source: TradingView</div>
    </section>

    <!-- MSTR mNAV Trend (StrategyTracker embed with fallback) -->
    <section class="card span-12">
      <h3 style="margin-top:0">MSTR — NAV Premium (Basic)</h3>
      <div id="mnav-embed" class="ratio-box"></div>
      <div class="small muted">Source: StrategyTracker. If the embed is blocked, use the button to open in a new tab.</div>
      <div class="actions">
        <a class="btn" href="https://strategytracker.com/mstr" target="_blank" rel="noopener">Open on StrategyTracker ↗</a>
      </div>
    </section>

    <!-- Notes -->
    <section class="card span-12">
      <h3 style="margin-top:0">How risk is computed</h3>
      <p class="small muted">Risk = 70% Fear &amp; Greed (0–100) + 30% of |24h % change| clamped at 10% (scaled to 0–100). Personal use only; not financial advice.</p>
      <ul class="small">
        <li><b>Low</b>: composite &lt; 40</li>
        <li><b>Medium</b>: 40–65</li>
        <li><b>High</b>: &gt; 65</li>
      </ul>
    </section>
  </main>

  <footer>Built for personal use • Data: Binance, Alternative.me, frankfurter.app, TradingView, StrategyTracker</footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    const els = {
      updated: document.getElementById('updated'),
      price: document.getElementById('price'),
      priceChange: document.getElementById('priceChange'),
      fgi: document.getElementById('fgi'),
      fgiLabel: document.getElementById('fgiLabel'),
      riskPill: document.getElementById('riskPill'),
      usdsek: document.getElementById('usdsek'),
      tvBtcd: document.getElementById('tv-btcd'),
      mnavBox: document.getElementById('mnav-embed'),
    };
    const fmtUSD = (n) => Number(n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2});
    const fmt2 = (n) => (isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:2}) : "—");

    /* ---------- KPIs ---------- */
    async function fetchBinance(){
      const r = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT');
      if (!r.ok) throw new Error('Binance API error');
      const j = await r.json();
      const last = j.lastPrice;
      const chgPct = parseFloat(j.priceChangePercent);
      els.price.textContent = fmtUSD(last);
      els.priceChange.textContent = `${chgPct.toFixed(2)}% (24h)`;
      els.priceChange.className = 'small ' + (chgPct >= 0 ? 'chg up' : 'chg down');
      return { last: parseFloat(last), chgPct };
    }

    async function fetchFearGreed(limit=30){
      const r = await fetch(`https://api.alternative.me/fng/?limit=${limit}&format=json`);
      if (!r.ok) throw new Error('F&G API error');
      const { data } = await r.json();
      const cur = data[0];
      els.fgi.textContent = cur.value;
      els.fgiLabel.textContent = cur.value_classification;
      const series = data.slice().reverse().map(d => ({
        t: new Date(parseInt(d.timestamp,10)*1000),
        v: parseInt(d.value,10)
      }));
      return { current: parseInt(cur.value,10), series };
    }

    async function fetchUsdSek(){
      const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=SEK');
      if (!r.ok) throw new Error('USD/SEK API error');
      const j = await r.json();
      const rate = j.rates?.SEK ?? null;
      els.usdsek.textContent = rate ? `${fmt2(rate)} SEK` : "—";
      return rate;
    }

    function computeRisk(fgi, chgPct){
      const vol = Math.min(Math.abs(chgPct || 0), 10) * 10; // 0–100
      return 0.7 * fgi + 0.3 * vol;
    }

    /* ---------- Charts ---------- */
    function lineChart(canvasId, label, points, yTitle, beginAtZero=false){
      if (!window.Chart) return;
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx,{
        type:'line',
        data:{ labels: points.map(p => p.t.toLocaleDateString()),
          datasets:[{ label, data: points.map(p => p.v), tension:0.3, fill:false }] },
        options:{
          responsive:true,
          scales:{ y:{ beginAtZero, title:{ display:true, text:yTitle } } },
          plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } }
        }
      });
    }
    function drawFgiChart(points){ lineChart('fgiChart','Fear & Greed',points,'Index (0–100)', true); }

    /* ---------- TradingView (reusable + retry) ---------- */
    function mountTradingView(container, symbol, attempt = 0){
      container.innerHTML = '';
      try{
        const s = document.createElement('script');
        s.src = "https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js";
        s.async = true;
        s.innerHTML = JSON.stringify({
          autosize:false, width:"100%", height:420,
          symbol, interval:"D",
          timezone:"Europe/Stockholm",
          theme:(matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? "dark" : "light",
          style:"3", locale:"en", withdateranges:true,
          hide_side_toolbar:true, hide_top_toolbar:false,
          allow_symbol_change:false, hide_legend:true, studies:[],
          backgroundColor:"transparent"
        });
        const wrap = document.createElement('div');
        wrap.className = "tradingview-widget-container";
        wrap.style.height = "420px";
        const cont = document.createElement('div');
        cont.className = "tradingview-widget-container__widget";
        cont.style.height = "100%";
        wrap.appendChild(cont); wrap.appendChild(s);
        container.appendChild(wrap);

        setTimeout(() => {
          const iframe = container.querySelector('iframe');
          const broken = !iframe || iframe.clientHeight < 200 || iframe.clientWidth < 200;
          if (broken && attempt < 3) mountTradingView(container, symbol, attempt+1);
          if (broken && attempt >= 3) {
            container.innerHTML = `<div class="small muted">Chart failed to load. 
              <a href="https://www.tradingview.com/chart?symbol=${encodeURIComponent(symbol)}" target="_blank" rel="noopener">Open in TradingView ↗</a></div>`;
          }
        }, 2500);
      }catch(e){
        if (attempt < 3) setTimeout(() => mountTradingView(container, symbol, attempt+1), 1000);
      }
    }

    /* ---------- StrategyTracker embed with fallback ---------- */
    function mountMnavEmbed(){
      const iframe = document.createElement('iframe');
      iframe.src = "https://strategytracker.com/mstr?embed=1";
      iframe.loading = "lazy";
      iframe.referrerPolicy = "no-referrer-when-downgrade";

      const fallback = document.createElement('div');
      fallback.className = "center small muted";
      fallback.innerHTML = 'Unable to embed StrategyTracker here. <a href="https://strategytracker.com/mstr" target="_blank" rel="noopener">Open on StrategyTracker ↗</a>';

      let embedded = false;
      iframe.addEventListener('load', () => { embedded = true; });
      setTimeout(() => {
        if (!embedded) { els.mnavBox.innerHTML = ""; els.mnavBox.appendChild(fallback); }
      }, 3000);

      els.mnavBox.appendChild(iframe);
    }

    /* ---------- Init ---------- */
    async function init(){
      try{
        const [bin, fgi] = await Promise.all([fetchBinance(), fetchFearGreed(30)]);
        const composite = computeRisk(fgi.current, bin.chgPct);
        let level='HIGH', cls='risk-high';
        if (composite < 40){ level='LOW'; cls='risk-low'; }
        else if (composite <= 65){ level='MEDIUM'; cls='risk-medium'; }
        els.riskPill.className = 'risk-pill ' + cls;
        els.riskPill.textContent = `${level} (${Math.round(composite)})`;
        drawFgiChart(fgi.series);
      }catch(err){
        console.error(err);
        els.updated.textContent = "Some data failed to load. Try refresh.";
      }

      fetchUsdSek().catch(()=>{});

      // Load widgets
      setTimeout(() => mountTradingView(els.tvBtcd, "CRYPTOCAP:BTC.D", 0), 60);
      setTimeout(() => mountMnavEmbed(), 120);

      els.updated.textContent = "Updated: " + new Date().toLocaleString();
    }
    init();

    // Reload handler for BTC.D
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-reload="btcd"]');
      if (btn) mountTradingView(els.tvBtcd, "CRYPTOCAP:BTC.D", 0);
    });
  </script>
</body>
</html>
